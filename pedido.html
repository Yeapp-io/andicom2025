<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon"href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçπ</text></svg>">
  <link rel="stylesheet" href="./css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <title>App C√≥cteles</title>

  <link rel="stylesheet" href="./css/pedido.css">
  <style>
    .pedido-vertical {
      width: 100%;
      background-color: transparent;
      border-bottom: 1px solid #ccc;
    }

    .pedido-vertical th {
      text-align: left;
      padding: 10px;
      width: 120px;
      font-size: 3rem;
    }

    .pedido-vertical td {
      padding: 10px;
      font-size: 3rem;
    }

    .pedido-vertical img {
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <h1 class="banner-title" style="margin: 5rem 3rem;">Revisa la informaci√≥n de tu pedido aqu√≠</h1>
  <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <canvas id="qr"></canvas>

  </div>
  <div style="margin: 2rem;">
    <h4 class="banner-desc">¬°Tu pedido est√° casi listo! ‚è≥</h4>
    <h4 class="banner-desc">Ac√©rcate a la barra con tu QR o t√≥male una foto al detalle de tu pedido</h4>
  </div>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <div style="margin: 2rem;" id="pedido-detalle">

    </div>
  </div>
  <h4 style="margin: 3rem;" class="banner-desc">Queremos conocerte un poco m√°s <br> D√©janos sorprenderte üéâ</h4>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <button style="font-size:2.5rem;" onclick="window.location.href='registro.html'" class="btn btn-primary"
      style="margin: 2rem 0; font-size:2rem;">
      Registar mis datos
    </button>
  </div>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <button style="font-size:2.5rem;" onclick="window.location.href='index.html'" class="btn btn-primary"
      style="margin: 2rem 0; font-size:2rem;">
      Finalizar
    </button>

    <p style="display: flex; flex-direction: column; align-items: center; margin: 3rem 1rem;" id="timer">Redirigiendo en
      90 segundos...</p>

  </div>

  <script>
    let seconds = 120;
    const timerElement = document.getElementById("timer");

    const interval = setInterval(() => {
      seconds--;
      timerElement.textContent = `Redirigiendo en ${seconds} segundos...`;

      if (seconds <= 0) {
        clearInterval(interval);
        window.location.href = "index.html";
      }
    }, 1000);
  </script>




  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Apenas cargue la p√°gina empieza el temporizador
    window.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        window.location.href = "index.html"; // Redirecci√≥n
      }, 90 * 1000); // 90 segundos en milisegundos
    });
    // üîß Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBXuxvb6yQgK9UYI7s9Ez89L2btjVypyQs",
      authDomain: "app-cocteles-56536.firebaseapp.com",
      projectId: "app-cocteles-56536",
      storageBucket: "app-cocteles-56536.appspot.com",
      messagingSenderId: "137807744816",
      appId: "1:137807744816:web:61fcba05330f2a128d02f5",
      measurementId: "G-ZSCCQ6919V"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîé Obtener ID del pedido desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const pedidoId = urlParams.get("id");

    const pedidoBody = document.getElementById("pedido-body");

    async function cargarPedido() {
      let pedido = null;

      // 1Ô∏è‚É£ Primero buscar en localStorage
      const localData = localStorage.getItem(pedidoId);
      if (localData) {
        console.log("Pedido cargado desde localStorage");
        pedido = JSON.parse(localData);
      } else {
        // 2Ô∏è‚É£ Si no est√° en localStorage, buscar en Firestore
        console.log("Buscando pedido en Firestore...");
        const pedidoRef = doc(db, "pedidos", pedidoId);
        const pedidoSnap = await getDoc(pedidoRef);
        if (pedidoSnap.exists()) {
          pedido = pedidoSnap.data();
          // Guardar en localStorage para futuras cargas offline
          localStorage.setItem(pedidoId, JSON.stringify(pedido));
        } else {
          //alert("Pedido no encontrado");
          Swal.fire({
            icon: 'error',
            title: '‚ùå Pedido no encontrado',
            text: 'No pudimos localizar el pedido con el ID ingresado. Verifica la informaci√≥n e int√©ntalo nuevamente.',
            confirmButtonText: 'Entendido'
          });

          return;
        }
      }

      // üìù Renderizar tabla
      console.log("Esto es pedido :D ", pedido);

      renderPedido(pedido);
      // üì≤ Generar QR
      const qrContainer = document.getElementById("qr");
      qrContainer.innerHTML = "";
      QRCode.toCanvas(qrContainer, window.location.href, { width: 350 }, function (error) {
        if (error) console.error(error);
      });
    }

    function renderPedido(pedido) {
      const contenedor = document.getElementById("pedido-detalle");
      contenedor.innerHTML = "";

      // Crear contenedor principal
      const wrapper = document.createElement("div");
      wrapper.style.display = "flex";
      wrapper.style.flexDirection = "column";
      wrapper.style.alignItems = "center";

      // T√≠tulo
      const titulo = document.createElement("h2");
      titulo.classList.add("banner-title");
      titulo.textContent = "Detalle del pedido";
      wrapper.appendChild(titulo);

      // Turno
      const turno = document.createElement("h4");
      turno.classList.add("banner-desc");
      turno.textContent = `Turno: ${pedido.turno}`;
      wrapper.appendChild(turno);

      // Contenedor de cocteles
      const detalle = document.createElement("div");
      detalle.id = "pedido-detalle-cocteles";

      pedido.cocteles.forEach(item => {
        const card = document.createElement("div");
        card.classList.add("pedido-horizontal");

        card.innerHTML = `
        <div class="pedido-img">
            <img src="${item.imagen || './img/default.jpg'}" alt="${item.nombre}" width="350" style="border-radius:8px;">
        </div>
        <div class="pedido-info">
            <p style="margin: 0; font-size: 1.5rem;"><b>${item.nombre}</b></p>
            <img src="${item.aliado}" alt="${item.nombre}" style="width:150px; border-radius:8px; margin-bottom: 2rem;">
            <p style="margin: 0; font-size: 1.3rem;">Cantidad<br><b>${item.cantidad}</b><br></p>
        </div>
        
    `;

        detalle.appendChild(card);
      });

      wrapper.appendChild(detalle);

      // Fecha
      const fecha = document.createElement("h4");
      fecha.classList.add("banner-desc");
      fecha.textContent = `Fecha: ${pedido.fecha}`;
      wrapper.appendChild(fecha);

      // Render final en el contenedor
      contenedor.appendChild(wrapper);
    }


    cargarPedido();
  </script>
</body>

</html>