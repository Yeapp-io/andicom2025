<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçπ</text></svg>">
    <title>App C√≥cteles</title>
    <link rel="stylesheet" href="./css/gestion.css" />
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="bg-transition"></div>
    <div class="container-nav">
        <nav class="nav-custom">
            <a class="nav-link active" data-tab="pedidos">Pedidos</a>
            <a class="nav-link" data-tab="cocteles">C√≥cteles</a>
            <a class="nav-link" data-tab="clientes">Clientes</a>
        </nav>
        <div class="tab-content">
            <!-- Pedidos -->
            <div class="tab-pane active" id="pedidos">
                <section class="screen">
                    <div class="banner-inner">
                        <h1 class="banner-title">Gesti√≥n de pedidos</h1>
                        <div id="tabla-pedidos"></div>
                    </div>
                </section>
            </div>
            <!-- Cocteles -->
            <div class="tab-pane" id="cocteles">
                <section class="screen">
                    <div class="banner-inner">
                        <h1 class="banner-title">Gesti√≥n de c√≥cteles</h1>
                        <div id="tabla-cocteles"></div>
                    </div>
                </section>
            </div>
            <!-- Clientes -->
            <div class="tab-pane" id="clientes">
                <section class="screen">
                    <div class="banner-inner">
                        <h1 class="banner-title">Gesti√≥n de clientes</h1>
                        <div id="tabla-clientes"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXuxvb6yQgK9UYI7s9Ez89L2btjVypyQs",
            authDomain: "app-cocteles-56536.firebaseapp.com",
            projectId: "app-cocteles-56536",
            storageBucket: "app-cocteles-56536.appspot.com",
            messagingSenderId: "137807744816",
            appId: "1:137807744816:web:61fcba05330f2a128d02f5",
            measurementId: "G-ZSCCQ6919V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Render Cocteles
        // Render Cocteles con edici√≥n
        async function renderCocteles() {
            const querySnapshot = await getDocs(collection(db, "cocteles"));
            let html = `<table>
            <tr>
              <th>ID</th><th>Nombre</th><th>Descripci√≥n</th><th>Disponibles</th><th>Estado</th>
            </tr>`;
            querySnapshot.forEach(docSnap => {
                const c = docSnap.data();
                html += `<tr>
          <td>${c.id_coctel}</td>
          <td>${c.nombre}</td>
          <td>${c.descripcion}</td>
          <td>
            <input type="number" class="disponibles-input" data-id="${docSnap.id}" value="${c.disponibles}" min="0" style="width:70px" />
            <button class="guardar-cantidad" data-id="${docSnap.id}">Guardar</button>
          </td>
          <td>
            <select class="estado-coctel" data-id="${docSnap.id}">
              <option value="Activo" ${c.estado === "Activo" ? "selected" : ""}>Activo</option>
              <option value="Inactivo" ${c.estado === "Inactivo" ? "selected" : ""}>Inactivo</option>
              <option value="Agotado" ${c.estado === "Agotado" ? "selected" : ""}>Agotado</option>
            </select>
          </td>
        </tr>`;
            });
            html += "</table>";
            document.getElementById("tabla-cocteles").innerHTML = html;

            // Guardar cantidad disponibles
            document.querySelectorAll(".guardar-cantidad").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    const input = document.querySelector(`.disponibles-input[data-id="${id}"]`);
                    const nuevaCantidad = parseInt(input.value);

                    try {
                        const coctelRef = doc(db, "cocteles", id);
                        await updateDoc(coctelRef, { disponibles: nuevaCantidad });
                        console.log(`‚úÖ Cantidad actualizada a ${nuevaCantidad} para c√≥ctel ${id}`);
                    } catch (error) {
                        console.error("‚ùå Error al actualizar cantidad:", error);
                    }
                });
            });

            // Actualizar estado
            document.querySelectorAll(".estado-coctel").forEach(select => {
                select.addEventListener("change", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    const nuevoEstado = e.target.value;

                    try {
                        const coctelRef = doc(db, "cocteles", id);
                        await updateDoc(coctelRef, { estado: nuevoEstado });
                        console.log(`‚úÖ Estado actualizado a "${nuevoEstado}" para c√≥ctel ${id}`);
                    } catch (error) {
                        console.error("‚ùå Error al actualizar estado:", error);
                    }
                });
            });
        }


        // Render Clientes
        async function renderClientes() {
            const querySnapshot = await getDocs(collection(db, "clientes"));
            let html = `<table>
                    <tr>
                      <th>Nombre</th><th>Apellidos</th><th>Correo</th><th>Tel√©fono</th>
                    </tr>`;
            querySnapshot.forEach(doc => {
                const c = doc.data();
                html += `<tr>
                  <td>${c.nombre}</td>
                  <td>${c.apellidos}</td>
                  <td>${c.correo}</td>
                  <td>${c.telefono}</td>
                </tr>`;
            });
            html += "</table>";
            document.getElementById("tabla-clientes").innerHTML = html;
        }

        // Render Pedidos
        // --- Render Pedidos con control de estado ---
        // Render Pedidos
        // Render Pedidos
        async function renderPedidos() {
            const querySnapshot = await getDocs(collection(db, "pedidos"));
            let html = `<table>
            <tr>
              <th>Turno</th><th>Fecha</th><th>Estado</th><th>Detalle C√≥cteles</th>
            </tr>`;
            querySnapshot.forEach(doc => {
                const p = doc.data();
                let detalle = "<ul>";
                p.cocteles.forEach(c => {
                    detalle += `<li>${c.nombre} - Cant: ${c.cantidad}</li>`;
                });
                detalle += "</ul>";

                // üîπ Guardamos el ID del documento en data-id
                html += `<tr>
          <td>${p.turno}</td>
          <td>${p.fecha}</td>
          <td>
            <select class="estado-select" data-id="${doc.id}">
              <option value="Pendiente" ${p.estado === "Pendiente" ? "selected" : ""}>Pendiente</option>
              <option value="En proceso" ${p.estado === "En proceso" ? "selected" : ""}>En proceso</option>
              <option value="Entregado" ${p.estado === "Entregado" ? "selected" : ""}>Entregado</option>
            </select>
          </td>
          <td>${detalle}</td>
        </tr>`;
            });
            html += "</table>";
            document.getElementById("tabla-pedidos").innerHTML = html;

            // üîπ Ahora s√≠ usamos el id desde data-id
            document.querySelectorAll(".estado-select").forEach(select => {
                select.addEventListener("change", async (e) => {
                    const pedidoId = e.target.getAttribute("data-id"); // obtenemos id del pedido
                    const nuevoEstado = e.target.value;

                    try {
                        const pedidoRef = doc(db, "pedidos", pedidoId);
                        await updateDoc(pedidoRef, { estado: nuevoEstado });
                        console.log(`Estado actualizado a ${nuevoEstado} para pedido ${pedidoId}`);
                    } catch (error) {
                        console.error("Error al actualizar estado:", error);
                    }
                });
            });
        }

        // Llamar todo
        renderCocteles();
        renderClientes();
        renderPedidos();

        // Navegaci√≥n tabs
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function (ev) {
                ev.preventDefault();
                document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                const paneId = this.getAttribute('data-tab');
                const pane = document.getElementById(paneId);
                if (pane) pane.classList.add('active');
                document.body.className = 'bg-' + paneId;
            });
        });
    </script>
</body>

</html>