<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçπ</text></svg>">
    <title>App C√≥cteles</title>
    <link rel="stylesheet" href="./css/gestion.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="bg-transition"></div>
    <div class="container-nav">
        <nav class="nav-custom">
            <a class="nav-link active" data-tab="pedidos">Pedidos</a>
            <a class="nav-link" data-tab="cocteles">C√≥cteles</a>
        </nav>
        <div class="tab-content">
            <!-- Pedidos -->
            <div class="tab-pane active" id="pedidos">
                <section class="screen">
                    <div class="banner-inner">
                        <h1 class="banner-title">Gesti√≥n de pedidos pendientes</h1>
                        <div id="tabla-pedidos"></div>
                    </div>
                </section>
            </div>
            <!-- Cocteles -->
            <div class="tab-pane" id="cocteles">
                <section class="screen">
                    <div class="banner-inner">
                        <h1 class="banner-title">Gesti√≥n de c√≥cteles</h1>
                        <div id="tabla-cocteles"></div>
                    </div>
                </section>
            </div>

        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXuxvb6yQgK9UYI7s9Ez89L2btjVypyQs",
            authDomain: "app-cocteles-56536.firebaseapp.com",
            projectId: "app-cocteles-56536",
            storageBucket: "app-cocteles-56536.appspot.com",
            messagingSenderId: "137807744816",
            appId: "1:137807744816:web:61fcba05330f2a128d02f5",
            measurementId: "G-ZSCCQ6919V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Render Cocteles
        // Render Cocteles con edici√≥n
        async function renderCocteles() {
            const querySnapshot = await getDocs(collection(db, "cocteles"));
            let html = `<table>
            <tr>
              <th>ID</th><th>Nombre</th><th>Descripci√≥n</th><th>Disponibles</th>
            </tr>`;
            querySnapshot.forEach(docSnap => {
                const c = docSnap.data();
                html += `<tr>
          <td>${c.id_coctel}</td>
          <td>${c.nombre}</td>
          <td>${c.descripcion}</td>
          <td>
            <input type="number" class="disponibles-input" data-id="${docSnap.id}" value="${c.disponibles}" min="0" style="width:70px" />
            <button class="guardar-cantidad btn btn-primary" data-id="${docSnap.id}">Guardar</button>
          </td>
        </tr>`;
            });
            html += "</table>";
            document.getElementById("tabla-cocteles").innerHTML = html;

            // Guardar cantidad disponibles
            document.querySelectorAll(".guardar-cantidad").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    const input = document.querySelector(`.disponibles-input[data-id="${id}"]`);
                    const nuevaCantidad = parseInt(input.value);

                    try {
                        const coctelRef = doc(db, "cocteles", id);
                        await updateDoc(coctelRef, { disponibles: nuevaCantidad });
                        console.log(`‚úÖ Cantidad actualizada a ${nuevaCantidad} para c√≥ctel ${id}`);
                    } catch (error) {
                        console.error("‚ùå Error al actualizar cantidad:", error);
                    }
                });
            });

            // Actualizar estado
            document.querySelectorAll(".estado-coctel").forEach(select => {
                select.addEventListener("change", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    const nuevoEstado = e.target.value;

                    try {
                        const coctelRef = doc(db, "cocteles", id);
                        await updateDoc(coctelRef, { estado: nuevoEstado });
                        console.log(`‚úÖ Estado actualizado a "${nuevoEstado}" para c√≥ctel ${id}`);
                    } catch (error) {
                        console.error("‚ùå Error al actualizar estado:", error);
                    }
                });
            });
        }

        // Render Pedidos
        // --- Render Pedidos con control de estado ---

        // Render solo pedidos pendientes
        async function renderPedidosPendientes() {
            try {
                // üîπ Query para traer solo los que tengan estado = Pendiente
                const q = query(collection(db, "pedidos"), where("estado", "==", "Pendiente"));
                const querySnapshot = await getDocs(q);

                let html = `<table>
        <tr>
          <th>Turno</th><th>Fecha</th><th>Detalle C√≥cteles</th><th>Estado</th>
        </tr>`;

                querySnapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    let detalle = "<ul>";
                    p.cocteles.forEach(c => {
                        detalle += `<li>${c.nombre} - Cantidad: ${c.cantidad}</li>`;
                    });
                    detalle += "</ul>";

                    html += `<tr>
              <td>${p.turno}</td>
              <td>${p.fecha}</td>
              <td>${detalle}</td>
              <td>
                <select class="estado-select" data-id="${docSnap.id}">
                  <option value="Pendiente" ${p.estado === "Pendiente" ? "selected" : ""}>Pendiente</option>
                  <option value="Entregado" ${p.estado === "Entregado" ? "selected" : ""}>Entregado</option>
                </select>
                <button class="guardar-estado btn btn-primary" 
                        data-id="${docSnap.id}" 
                        data-turno="${p.turno}">
                  Guardar
                </button>
              </td>
            </tr>`;
                });

                html += "</table>";
                document.getElementById("tabla-pedidos").innerHTML = html;

                // Guardar estado con SweetAlert
                document.querySelectorAll(".guardar-estado").forEach(btn => {
                    btn.addEventListener("click", async (e) => {
                        const id = e.target.getAttribute("data-id");
                        const turno = e.target.getAttribute("data-turno");
                        const select = document.querySelector(`.estado-select[data-id="${id}"]`);
                        const nuevoEstado = select.value;

                        try {
                            const pedidoRef = doc(db, "pedidos", id);
                            await updateDoc(pedidoRef, { estado: nuevoEstado });

                            Swal.fire({
                                icon: 'success',
                                title: 'Estado actualizado',
                                text: `El pedido con turno "${turno}" ahora est√° en estado "${nuevoEstado}"`,
                                timer: 2500,
                                showConfirmButton: false,
                                timerProgressBar: true
                            });

                            // üîÑ Recargar tabla para que desaparezca si ya no es "Pendiente"
                            renderPedidosPendientes();

                        } catch (error) {
                            console.error("‚ùå Error al actualizar estado:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudo actualizar el estado. Intenta nuevamente.',
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    });
                });

            } catch (error) {
                console.error("‚ùå Error al leer pedidos:", error);
            }
        }

        // üîπ Llamar la funci√≥n cuando cargue la p√°gina
        renderPedidosPendientes();

        // Llamar todo
        renderCocteles();
        renderPedidos();

        // Navegaci√≥n tabs
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function (ev) {
                ev.preventDefault();
                document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                const paneId = this.getAttribute('data-tab');
                const pane = document.getElementById(paneId);
                if (pane) pane.classList.add('active');
                document.body.className = 'bg-' + paneId;
            });
        });
    </script>
</body>

</html>